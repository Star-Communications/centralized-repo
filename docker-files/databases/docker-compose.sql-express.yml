version: "3.9"

networks:
  MY-NETWORK-NAME:
    external: true

services:
  sql-express:
    image: mcr.microsoft.com/mssql/server:2019-latest
    container_name: sql-express
    restart: unless-stopped
    volumes:
      # what is this for??
      # - SQL_volume:/vol
      # persist the data in the host machine
      - ./mssql-express/data:/var/opt/mssql/data
      # persist the logs in the host machine
      - ./mssql-express/log:/var/opt/mssql/log
      # secrets store sensitive configuration (like passwords, certificates & encryption keys)
      - ./mssql-express/secrets:/var/opt/mssql/secrets
      # bind 'SC-TRACKER' to store the DB backup files there
      # '../' relative path assuming docker-compose file is in '/home/ubuntu/UTILITIES/docker-compose.yml' & '/home/ubuntu/SC-TRACKER'
      # '/app/SC-TRACKER' as this is the 'ROOT_FOLDER_PATH' defined in appsetting.Docker.json
      - ../SC-TRACKER:/app/SC-TRACKER
    ports:
      - "1433:1433"
    networks:
      - MY-NETWORK-NAME
    environment:
      - ACCEPT_EULA=Y # Accept the end user license agreement
      - MSSQL_SA_PASSWORD=Sa@12345 # Specify the SA password
      - MSSQL_PID=Express # Specify the SQL Server edition to be express edition
#
# [INSTRUCTIONS]
# 1) Add this 'docker-compose' file to 'UTILITIES/'
# 2) Create 'mssql-express' folder in 'UTILITIES/'
# 3) Rename MY-NETWORK-NAME to your desired network name !!!
# 4) Start container
#   a) cd into 'UTILITIES/'
#   b) Run 'docker compose --file ./docker-compose.sql-express.yml up -d --build'
# 5) Update permissions of directories (cd into 'UTILITIES/'):
#   'sudo chmod -R 2777 .'
# 6) Update permissions of directories (cd into 'SC-TRACKER/'):
#   'sudo chmod -R 2777 .'
# ------------------------------------------------------------

# [AFTER STARTING THE CONTAINER]
# 1) Enter container's shell: 'docker exec -it sql-express sh'
#
# 2) Limit DB engine to 1 GB memory (RAM):
#   'echo -e "sp_configure 'show advanced options', 1; \n GO \n RECONFIGURE; \n GO \n sp_configure 'max server memory', 1024; \n GO \n RECONFIGURE; \n GO" > tmp/limit-memory.sql; /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P 'Sa@12345' -i tmp/limit-memory.sql'
#    explanation:
#     1) write T-SQL script to limit the DB engine to 1 GB memory into file 'tmp/limit-memory.sql'
#     2) run 'limit-memory.sql' sql script using 'sqlcmd -i' command
#
# 3) Connect to the SQL Server instance using sqlcmd:
#  /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P 'Sa@12345'
#
# 4) Create a new login for the user (run each line individually):
#  > CREATE LOGIN [SCTracker] WITH PASSWORD=N'SCTracker@123', DEFAULT_DATABASE=[master], CHECK_EXPIRATION=OFF, CHECK_POLICY=OFF;
#  > go
#
# 5) Verify new login user got created (run each line individually):
#  > SELECT name FROM sys.sql_logins;
#  > go
#
# 6) Make newly created user a member of 'sysadmin role' (not sure if best practice!!!) (run each line individually):
#  > EXEC sp_addsrvrolemember 'SCTracker', 'sysadmin';
#  > go
#
# 7) Verify user got added to 'sysadmin role' (run each line individually):
#  > SELECT IS_SRVROLEMEMBER('sysadmin', 'SCTracker');
#
# 8) Add new user with login Access and DB create Permission (needed if I let tracker-api create DB using login user??):
#  > CREATE LOGIN SCTracker WITH PASSWORD = 'SCTracker@123';
#  > GO
#  > CREATE USER SCTracker FOR LOGIN SCTracker
#  > GO
#
# 9) Set the model database to SIMPLE recovery mode:
#     This ensures all new databases automatically use SIMPLE recovery mode, which:
#     - Automatically truncates transaction logs to prevent disk space issues
#     Run the following commands in sqlcmd:
#  > ALTER DATABASE [model] SET RECOVERY SIMPLE;
#  > GO
#
# 10) Managing transaction log files for existing databases:
#     If you have existing databases with large log files, follow these steps to shrink them:
#
#     Step A: Check current log file sizes and names
#     > USE [YOUR_DATABASE_NAME];
#     > GO
#     > SELECT name AS LogicalName,
#     >        type_desc AS FileType,
#     >        size * 8 / 1024 AS SizeMB
#     > FROM sys.database_files;
#     > GO
#
#     Step B: Shrink each log file to 512 MB (replace YOUR_DATABASE_NAME and LOG_FILE_NAME with actual values)
#     > USE [YOUR_DATABASE_NAME];
#     > GO
#     > DBCC SHRINKFILE ('LOG_FILE_NAME', 512);
#     > GO
#
#     Note: Replace YOUR_DATABASE_NAME with your actual database name and LOG_FILE_NAME with the
#           LogicalName from Step A (usually ends with '_Log')
